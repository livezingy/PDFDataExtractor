# 表格类型预判原理说明文档

## 📋 概述

本文档详细说明PDF表格类型分类（有框表格 vs 无框表格）的判断原理，重点阐述基于MAD（中位数绝对偏差）的集中度计算方法。

---

## 🎯 问题背景

在PDF表格提取中，需要区分两种表格类型：

1. **有框表格（bordered table）**：具有明确的线条边框，形成封闭的单元格
2. **无框表格（unbordered table）**：没有明显的线条边框，依赖文本对齐形成结构

**判断难点**：
- 如何区分装饰性短线和功能性边框线？
- 如何判断线条是否形成有效的表格结构？
- 如何处理不规则表格和噪声数据？

---

## 🏗️ 整体架构：多层级判断逻辑

### 层级结构

```
层级1: 快速过滤（线条数量）
  ├─ 情况1: 线条不足 → unbordered
  └─ 情况2: 线条极多且对齐 → bordered

层级2: 标准判断（MAD集中度分析）
  └─ 使用MAD方法计算线条集中度
      ├─ 线条集中度
      ├─ 区域集中度
      └─ 方向平衡性
```

### 判断流程

```python
def predict_table_type():
    # 1. 快速过滤
    if h_count < 3 or v_count < 3:
        return 'unbordered'
    
    # 2. 动态阈值快速判断
    dynamic_threshold = calculate_dynamic_threshold()
    if h_count > threshold and v_count > threshold:
        if alignment_check() > 0.6:
            return 'bordered'
    
    # 3. MAD集中度分析
    concentration_score = mad_concentration_analysis()
    if concentration_score > 0.6:
        return 'bordered'
    else:
        return 'unbordered'
```

---

## 📊 层级1：快速过滤

### 1.1 线条数量不足判断

**规则**：如果水平线或垂直线数量少于3条，直接判定为无框表格

**理由**：
- 有框表格至少需要形成基本的网格结构
- 3条水平线 + 3条垂直线 = 至少2x2的单元格
- 少于这个数量无法形成有意义的表格结构

```python
if h_count < 3 or v_count < 3:
    return 'unbordered'
```

### 1.2 动态阈值快速判断

**改进**：使用动态阈值替代固定阈值20

**原理**：
- 基于页面尺寸自适应调整阈值
- A4页面（595x842pt）作为基准，阈值设为10
- 其他页面按面积比例缩放（使用平方根避免过大）

**计算公式**：
```python
area_ratio = page_area / a4_area
dynamic_threshold = base_threshold * sqrt(area_ratio)
dynamic_threshold = clamp(dynamic_threshold, 10, 30)
```

**优势**：
- ✅ 适应不同页面尺寸（A4、A3、Letter等）
- ✅ 避免小页面阈值过高，大页面阈值过低
- ✅ 保持合理的阈值范围（10-30）

**示例**：
| 页面尺寸 | 面积比例 | 计算阈值 | 最终阈值 |
|---------|---------|---------|---------|
| A4 (595x842) | 1.0 | 10 | 10 |
| A3 (842x1191) | 2.0 | 14 | 14 |
| Letter (612x792) | 0.9 | 9 | 10 |
| 大页面 (1200x1600) | 4.0 | 20 | 20 |

---

## 🔍 层级2：MAD集中度分析（核心方法）

### 2.1 MAD方法概述

**MAD（Median Absolute Deviation）**：中位数绝对偏差

**为什么选择MAD？**

| 对比维度 | 标准差 | 分位数 | **MAD** |
|---------|--------|--------|---------|
| **鲁棒性** | ❌ 对异常值敏感 | ⚠️ 中等 | ✅ **对异常值不敏感** |
| **计算复杂度** | O(n) | O(n log n) | O(n log n) |
| **适应性** | ⚠️ 需要正态分布假设 | ✅ 无需假设 | ✅ **无需分布假设** |
| **适用场景** | 理想数据 | 一般情况 | ✅ **含噪声的实际数据** |

**核心优势**：
1. **鲁棒性**：基于中位数，不受极值影响
2. **通用性**：适用于各种表格布局（规则、不规则、倾斜）
3. **自适应性**：能处理表格中心位置的变化

---

### 2.2 MAD原理详解

#### 2.2.1 基本概念

**MAD定义**：
```
MAD = median(|x_i - median(x)|)
```

**含义**：
- 计算每个数据点与中位数的绝对偏差
- 取这些偏差的中位数
- 衡量数据围绕中位数的离散程度

#### 2.2.2 计算步骤

**步骤1：收集所有线条端点坐标**

```python
all_x = []  # 所有x坐标（水平线的x0, x1）
all_y = []  # 所有y坐标（垂直线的y0, y1）

for line in all_lines:
    all_x.extend([line['x0'], line['x1']])
    all_y.extend([line['y0'], line['y1']])
```

**步骤2：计算坐标中位数**

```python
x_median = median(all_x)  # x坐标的中位数
y_median = median(all_y)  # y坐标的中位数
```

**步骤3：计算MAD（中位数绝对偏差）**

```python
# 计算每个点到中位数的绝对偏差
deviations_x = [|x - x_median| for x in all_x]
deviations_y = [|y - y_median| for y in all_y]

# 计算偏差的中位数（MAD）
x_mad = median(deviations_x)
y_mad = median(deviations_y)
```

**步骤4：定义集中区域**

```python
# 使用1.5倍MAD作为边界（类似3σ原则）
x_lower = x_median - 1.5 * x_mad
x_upper = x_median + 1.5 * x_mad
y_lower = y_median - 1.5 * y_mad
y_upper = y_median + 1.5 * y_mad

集中区域 = [x_lower, x_upper] × [y_lower, y_upper]
```

---

### 2.3 为什么使用1.5倍MAD？

#### 2.3.1 理论依据

**类比正态分布的3σ原则**：
- 正态分布：约99.7%的数据在 μ ± 3σ 范围内
- MAD方法：约50-70%的正常数据在 median ± 1.5*MAD 范围内

**1.5倍MAD的含义**：
- 对于对称分布，约覆盖50-70%的数据
- 对于有框表格，能覆盖大部分有效线条
- 对于无框表格，能过滤掉分散的装饰性线条

#### 2.3.2 系数选择

| 系数 | 覆盖率 | 适用场景 | 推荐 |
|------|--------|---------|------|
| 1.0*MAD | ~40-50% | 严格判断 | ⚠️ 可能过严 |
| **1.5*MAD** | **50-70%** | **平衡判断** | ✅ **推荐** |
| 2.0*MAD | ~70-85% | 宽松判断 | ⚠️ 可能过宽 |

**选择1.5的原因**：
- ✅ 平衡准确性和鲁棒性
- ✅ 经验值，在实践中表现良好
- ✅ 可调整（1.0-2.0范围）

---

### 2.4 集中度指标计算

#### 2.4.1 线条集中度

**定义**：集中区域内的线条数量占总线条数量的比例

```python
line_concentration = main_region_lines / total_lines
```

**含义**：
- 值越高，说明线条越集中，越可能是有框表格
- 值越低，说明线条越分散，越可能是无框表格

**示例**：
```
有框表格（10x10网格）：
- 总线条数：20条水平线 + 20条垂直线 = 40条
- 集中区域内线条：38条
- 线条集中度 = 38/40 = 0.95 ✅

无框表格（文本对齐）：
- 总线条数：5条装饰性短线
- 集中区域内线条：1条
- 线条集中度 = 1/5 = 0.20 ❌
```

#### 2.4.2 区域集中度

**定义**：集中区域面积占页面面积的比例

```python
area_ratio = main_region_area / page_area
```

**含义**：
- 值越小，说明表格区域越集中，越可能是有效的表格
- 值越大，说明线条分散在整个页面，可能是装饰性线条

**示例**：
```
有框表格（集中在页面中央）：
- 页面面积：500,000 pt²
- 集中区域面积：50,000 pt²
- 区域集中度 = 50,000/500,000 = 0.10 ✅

无框表格（线条分散）：
- 页面面积：500,000 pt²
- 集中区域面积：400,000 pt²
- 区域集中度 = 400,000/500,000 = 0.80 ❌
```

#### 2.4.3 方向平衡性

**定义**：水平线和垂直线的数量平衡程度

```python
direction_balance = min(h_count, v_count) / max(h_count, v_count)
```

**含义**：
- 值越接近1，说明水平线和垂直线数量越平衡
- 有框表格通常需要水平线和垂直线同时存在

**示例**：
```
有框表格（10x10网格）：
- 水平线：20条
- 垂直线：20条
- 方向平衡性 = 20/20 = 1.0 ✅

无框表格（只有水平分隔线）：
- 水平线：10条
- 垂直线：0条
- 方向平衡性 = 0/10 = 0.0 ❌
```

---

### 2.5 综合评分公式

**三维评分公式**：

```python
final_score = (
    line_concentration * 0.6 +      # 线条集中度（主要指标）
    (1.0 - area_ratio) * 0.2 +      # 区域集中度（反向指标）
    direction_balance * 0.2          # 方向平衡性（辅助指标）
)
```

**权重分配**：
- **线条集中度（60%）**：最重要的指标，直接反映线条是否形成有效结构
- **区域集中度（20%）**：辅助指标，反映表格区域是否集中
- **方向平衡性（20%）**：辅助指标，反映是否有完整的网格结构

**判断阈值**：
```python
if final_score > 0.6:
    return 'bordered'
else:
    return 'unbordered'
```

**阈值0.6的含义**：
- 经验值，在实践中表现良好
- 可调整（0.5-0.7范围）

---

## 📈 MAD方法优势

### 优势1：鲁棒性（对异常值不敏感）

**示例场景**：表格中有少量装饰性短线

```python
# 场景：10x10有框表格 + 5条装饰性短线
有框表格线条：20条水平线 + 20条垂直线（集中在中央）
装饰性短线：5条（分散在页面边缘）

# 使用标准差（敏感）
mean = 计算所有线条坐标的平均值
std = 计算标准差
# 问题：装饰性短线会影响平均值和标准差

# 使用MAD（不敏感）
median = 计算中位数（不受装饰性短线影响）
mad = 计算MAD（不受装饰性短线影响）
# 优势：装饰性短线不影响判断结果
```

### 优势2：通用性（适用于各种布局）

**适用场景**：
- ✅ 规则表格（整齐的网格）
- ✅ 不规则表格（单元格大小不一致）
- ✅ 倾斜表格（表格整体有轻微倾斜）
- ✅ 部分边框缺失的表格

**示例**：
```
规则表格：
- 线条高度对齐，MAD值小，集中度高 ✅

不规则表格：
- 线条不完全对齐，但仍在集中区域内
- MAD值适中，仍能正确判断 ✅

倾斜表格：
- 表格整体倾斜，但MAD能自适应调整
- 集中区域跟随表格中心移动 ✅
```

### 优势3：自适应性（无需预设参数）

**无需预设的参数**：
- ❌ 不需要预设表格位置
- ❌ 不需要预设表格大小
- ❌ 不需要预设线条对齐方式

**自适应调整**：
- ✅ 自动识别表格中心位置（中位数）
- ✅ 自动调整集中区域大小（MAD）
- ✅ 适应不同页面尺寸

---

## 🔬 算法复杂度分析

### 时间复杂度

| 步骤 | 操作 | 复杂度 |
|------|------|--------|
| 1. 收集坐标 | 遍历所有线条 | O(n) |
| 2. 计算中位数 | 排序后取中位数 | O(n log n) |
| 3. 计算MAD | 排序后取中位数 | O(n log n) |
| 4. 判断线条 | 遍历所有线条 | O(n) |
| **总复杂度** | | **O(n log n)** |

**主导复杂度**：排序操作（计算中位数需要排序）

### 空间复杂度

| 数据结构 | 大小 | 说明 |
|---------|------|------|
| all_x | O(n) | 存储所有x坐标 |
| all_y | O(n) | 存储所有y坐标 |
| deviations | O(n) | 临时存储偏差值 |
| **总空间** | **O(n)** | n为线条总数 |

---

## 🎨 实际应用示例

### 示例1：标准有框表格

**场景**：10x10的规则表格

```
水平线：20条（10条行分隔线 + 上下边框）
垂直线：20条（10条列分隔线 + 左右边框）

计算过程：
1. 收集坐标：40条线 × 2个端点 = 80个坐标点
2. 计算中位数：x_median ≈ 页面中心x, y_median ≈ 页面中心y
3. 计算MAD：x_mad ≈ 表格宽度/2, y_mad ≈ 表格高度/2
4. 集中区域：覆盖整个表格区域
5. 线条集中度：38/40 = 0.95
6. 区域集中度：0.15（表格占页面15%）
7. 方向平衡性：20/20 = 1.0

最终评分 = 0.95×0.6 + (1-0.15)×0.2 + 1.0×0.2 = 0.91 ✅
判断结果：bordered
```

### 示例2：无框表格（只有装饰性短线）

**场景**：文本对齐的表格，有5条装饰性短线

```
水平线：5条（分散在页面不同位置）
垂直线：0条

计算过程：
1. 收集坐标：5条线 × 2个端点 = 10个坐标点
2. 计算中位数：x_median ≈ 页面中心, y_median ≈ 页面中心
3. 计算MAD：x_mad较大（线条分散）, y_mad较大
4. 集中区域：覆盖大部分页面
5. 线条集中度：2/5 = 0.40
6. 区域集中度：0.80（集中区域占页面80%）
7. 方向平衡性：0/5 = 0.0

最终评分 = 0.40×0.6 + (1-0.80)×0.2 + 0.0×0.2 = 0.28 ❌
判断结果：unbordered
```

### 示例3：不规则有框表格

**场景**：单元格大小不一致的有框表格

```
水平线：15条（行分隔线不完全对齐）
垂直线：12条（列分隔线不完全对齐）

计算过程：
1. 收集坐标：27条线 × 2个端点 = 54个坐标点
2. 计算中位数：x_median ≈ 表格中心, y_median ≈ 表格中心
3. 计算MAD：x_mad较大（列宽度不一致）, y_mad较大（行高度不一致）
4. 集中区域：仍能覆盖大部分表格区域
5. 线条集中度：24/27 = 0.89
6. 区域集中度：0.20
7. 方向平衡性：12/15 = 0.80

最终评分 = 0.89×0.6 + (1-0.20)×0.2 + 0.80×0.2 = 0.77 ✅
判断结果：bordered
```

---

## 📝 总结

### MAD方法的核心优势

1. **鲁棒性**：对异常值不敏感，能处理含噪声的实际数据
2. **通用性**：适用于各种表格布局，无需预设参数
3. **自适应性**：自动识别表格中心位置和大小

### 适用场景

- ✅ 标准有框表格
- ✅ 不规则有框表格
- ✅ 部分边框缺失的表格
- ✅ 含装饰性线条的表格
- ✅ 倾斜表格

### 不适用场景

- ❌ 表格线条完全分散在页面各处（这种情况本身就是无框表格）
- ❌ 表格线条数量过少（已在层级1快速过滤）

---

## 🔗 相关文档

- [表格类型判断标准](./table_type_judgment_guide.md)
- [参数计算公式](../docs/camelot_parameter_calculation.md)

---

## 📅 文档版本

- **版本**：1.0
- **创建日期**：2025-01-XX
- **最后更新**：2025-01-XX
- **作者**：PDFDataExtractor Team

